const connection = require("../connection/db")

const notesController = {

  assignWaveNotes: async (req, res) => {
    try {
      const [onda] = await connection.query("SELECT id, bateria_id FROM onda ORDER BY id DESC LIMIT 1");
      const { id: ondaId, bateria_id: bateriaId } = onda[0];
  
      const [surfistas] = await connection.query("SELECT surfista_id FROM onda WHERE bateria_id = ?", [bateriaId]);
  
      const notas = [];
      for (const surfista of surfistas) {
        const { surfista_id: surfistaId } = surfista;
  
        const [surfistaNome] = await connection.query("SELECT nome FROM surfista WHERE id = ?", [surfistaId]);

        // Gerar notas parciais aleatórias
        const nota1 = Math.floor(Math.random() * 10) + 1;
        const nota2 = Math.floor(Math.random() * 10) + 1;
        const nota3 = Math.floor(Math.random() * 10) + 1;

        const notaFinal = (nota1 + nota2 + nota3) / 3
  
        await connection.query('INSERT INTO nota (onda_id, nota1, nota2, nota3, notaFinal, surfista_id, surfista_nome) VALUES (?, ?, ?, ?, ?, ?, ?)', [ondaId, nota1, nota2, nota3, notaFinal.toFixed(2), surfistaId, surfistaNome[0].nome]);
  
        notas.push({
          surfistaId: surfistaId,
          surfistaNome: surfistaNome[0].nome,
          nota1: nota1,
          nota2: nota2,
          nota3: nota3,
          notaFinal: notaFinal.toFixed(2)
        });
      }
  
      res.json({
        message: 'Notas atribuídas com sucesso!',
        ondaId: ondaId,
        notas: notas,
      });
    } catch (e) {
      console.log(e);
      res.json({
        error: "Error",
        status: '400',
      });
    }
  }
  
  
}

module.exports = notesController